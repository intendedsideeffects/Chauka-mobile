'use client';

import React, { useState, useEffect } from 'react';
import { BUTTON_POSITIONS, CHART_DIMENSIONS, GLOBAL_SEA_LEVEL_RISE } from './SeaLevelRiseChartConstants';

// ⚠️ CRITICAL: Button positioning has been carefully calibrated
// DO NOT modify BUTTON_POSITIONS without testing on multiple screen sizes
// Current positions: Select Parameter (6px), 2°C (140px), 4°C (240px), 2050 (140px), 2100 (260px)
// See BUTTON_POSITIONING.md for complete documentation
const SeaLevelRiseChart = () => {
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedDegree, setSelectedDegree] = useState('2');
  const [selectedYear, setSelectedYear] = useState('2050');

  useEffect(() => {
    const fetchData = async () => {
      try {
        const response = await fetch('/Coastal_Elevation_Exposure__Comma_Format_.csv');
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const csvText = await response.text();
        
        // Parse CSV with semicolon separator
        const lines = csvText.trim().split('\n');
        const headers = lines[0].split(';');
        
        const parsedData = lines.slice(1).map(line => {
          const values = line.split(';');
          return {
            country: values[0],
            threshold: parseFloat(values[1].replace(',', '.')),
            seaLevelRise2Degree2050: parseFloat(values[2].replace(',', '.')),
            seaLevelRise2Degree2100: parseFloat(values[3].replace(',', '.')),
            seaLevelRise4Degree2050: parseFloat(values[4].replace(',', '.')),
            seaLevelRise4Degree2100: parseFloat(values[5].replace(',', '.'))
          };
        }).filter(item => !isNaN(item.seaLevelRise2Degree2050));
        
        setData(parsedData);
        setLoading(false);
      } catch (error) {
        console.error('Error loading data:', error);
        setLoading(false);
      }
    };

    fetchData();
  }, []);

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-lg">Loading sea level rise data...</div>
      </div>
    );
  }

  // Get the selected data based on user choices
  const getSelectedData = () => {
    const columnName = `seaLevelRise${selectedDegree}Degree${selectedYear}`;
    return data.map(item => ({
      ...item,
      selectedValue: item[columnName]
    }));
  };

  const selectedData = getSelectedData();
  const maxValue = Math.max(...selectedData.map(d => d.selectedValue));
  
  const currentGlobalRise = GLOBAL_SEA_LEVEL_RISE[selectedYear][selectedDegree];

                             return (
      <div className="w-full bg-transparent relative" style={{...CHART_DIMENSIONS.container, pointerEvents: 'auto'}}>
                                                                                                                        {/* Controls - Scattered in top-right corner of page */}
                  <div className="absolute z-50" style={BUTTON_POSITIONS.CONTAINER}>
                   
                                     {/* Select Parameter Image */}
                   <div 
                     className="absolute"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     style={{
                        ...BUTTON_POSITIONS.SELECT_PARAMETER,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                      }}
                   >
                                         <img 
                       src="/selectparameter.png" 
                       alt="Select Parameter"
                       style={{
                         width: '100%',
                         height: '100%',
                         objectFit: 'contain',
                         transform: 'rotate(-20deg)'
                       }}
                     />
                  </div>                                     
                                                                                                                                                                                                                                                                                                     {/* 2°C Button - positioned randomly in top-right */}
                      <div 
                        className="absolute"
                                                style={{
                                                                                                                                                                                                                                     ...BUTTON_POSITIONS.TEMP_2C,
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          cursor: 'pointer',
                        }}
                        onClick={() => setSelectedDegree('2')}
                      >
                  <svg width="80" height="80" style={{ position: 'absolute', left: 0, top: 0, pointerEvents: 'none' }}>
                    <defs>
                      <path id="circlePath2C" d="M40,10 A30,30 0 1,1 39.99,10" />
                    </defs>
                    <circle cx="40" cy="40" r="25" fill={selectedDegree === '2' ? "#000" : "#d3d3d3"} />
                    <text fill={selectedDegree === '2' ? "#000" : "#666"} fontSize="12" fontWeight="bold" letterSpacing="0.08em">
                      <textPath xlinkHref="#circlePath2C" startOffset="0%" textAnchor="start" dominantBaseline="middle">
                        2°C
                      </textPath>
                    </text>
                  </svg>
                </div>

                                                                                                                                                                                                                                                                                                     {/* 4°C Button - positioned randomly in top-right */}
                      <div 
                        className="absolute"
                                                style={{
                                                                                                                                                                                                                                   ...BUTTON_POSITIONS.TEMP_4C,
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          cursor: 'pointer',
                        }}
                        onClick={() => setSelectedDegree('4')}
                      >
                  <svg width="80" height="80" style={{ position: 'absolute', left: 0, top: 0, pointerEvents: 'none' }}>
                    <defs>
                      <path id="circlePath4C" d="M40,10 A30,30 0 1,1 39.99,10" />
                    </defs>
                    <circle cx="40" cy="40" r="25" fill={selectedDegree === '4' ? "#000" : "#d3d3d3"} />
                    <text fill={selectedDegree === '4' ? "#000" : "#666"} fontSize="12" fontWeight="bold" letterSpacing="0.08em">
                      <textPath xlinkHref="#circlePath4C" startOffset="0%" textAnchor="start" dominantBaseline="middle">
                        4°C
                      </textPath>
                    </text>
                  </svg>
                </div>

                                                                                                                                                                                                                                                                               {/* 2050 Button - positioned randomly in top-right */}
                    <div 
                      className="absolute"
                                             style={{
                                                                                                                                                                                                                                                                                                                                                                                                                                           ...BUTTON_POSITIONS.YEAR_2050,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        cursor: 'pointer',
                      }}
                      onClick={() => setSelectedYear('2050')}
                    >
                  <svg width="120" height="120" style={{ position: 'absolute', left: 0, top: 0, pointerEvents: 'none' }}>
                    <defs>
                      <path id="circlePath2050" d="M60,15 A45,45 0 1,1 59.99,15" />
                    </defs>
                    <circle cx="60" cy="60" r="40" fill={selectedYear === '2050' ? "#000" : "#d3d3d3"} />
                    <text fill={selectedYear === '2050' ? "#000" : "#666"} fontSize="14" fontWeight="bold" letterSpacing="0.08em">
                      <textPath xlinkHref="#circlePath2050" startOffset="0%" textAnchor="start" dominantBaseline="middle">
                        2050
                      </textPath>
                    </text>
                  </svg>
                </div>

                                                                   {/* 2100 Button - positioned randomly in top-right */}
                  <div 
                    className="absolute"
                                         style={{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ...BUTTON_POSITIONS.YEAR_2100,
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      cursor: 'pointer',
                    }}
                    onClick={() => setSelectedYear('2100')}
                  >
                  <svg width="120" height="120" style={{ position: 'absolute', left: 0, top: 0, pointerEvents: 'none' }}>
                    <defs>
                      <path id="circlePath2100" d="M60,15 A45,45 0 1,1 59.99,15" />
                    </defs>
                    <circle cx="60" cy="60" r="40" fill={selectedYear === '2100' ? "#000" : "#d3d3d3"} />
                    <text fill={selectedYear === '2100' ? "#000" : "#666"} fontSize="14" fontWeight="bold" letterSpacing="0.08em">
                      <textPath xlinkHref="#circlePath2100" startOffset="0%" textAnchor="start" dominantBaseline="middle">
                        2100
                      </textPath>
                    </text>
                  </svg>
                </div>
              </div>

                                                           <div>

                             <div className="relative" style={{ width: '100%', height: '100%' }}>
                   {/* Global sea level rise annotation */}
                   <div className="absolute z-30" style={{ 
                      top: `${350 - (currentGlobalRise / 1.0) * 280 - 8}px`,
                      left: '-200px'
                   }}>
                     <div className="text-sm text-gray-600 font-medium text-right">
                       Global Sea Level Rise: {currentGlobalRise.toFixed(2)}M
                     </div>
                   </div>
                   
                                       {/* Extended line across the chart */}
                    <div className="absolute left-0 right-0 z-25" style={{ 
                       top: `${350 - (currentGlobalRise / 1.0) * 280}px`
                    }}>
                      <div className="border-t border-gray-400" style={{ height: '1px' }}></div>
                    </div>
                   {/* Chart area with bars */}
                           <div className="flex items-end justify-between h-[350px] relative">
                         {/* Dynamic blue gradient rectangle behind bars */}
                         <div 
                           className="absolute left-0 right-0 z-5"
                           style={{
                             top: `${350 - (currentGlobalRise / 1.0) * 280}px`,
                             height: `${(currentGlobalRise / 1.0) * 280}px`,
                             background: 'linear-gradient(to bottom, rgba(59, 130, 246, 0.3) 0%, rgba(59, 130, 246, 0.1) 50%, transparent 100%)',
                             border: 'none'
                           }}
                         />
                         {/* Zero line positioned directly under bars */}
             <div className="absolute bottom-0 left-0 right-0 border-t border-black"></div>
            
                                                  {selectedData.map((item, index) => {
                           const barHeight = (item.selectedValue / 1.0) * 280;
                           const globalLineHeight = (currentGlobalRise / 1.0) * 280;
                           const isAboveGlobal = item.selectedValue > currentGlobalRise;
                           
                           return (
             <div key={index} className="flex flex-col items-center flex-1 mx-1">
                                                           {/* Bar */}
                                <div className="relative flex justify-center">
                                                                          {isAboveGlobal ? (
                                                                          <>
                                                                            {/* Blue portion above global average */}
                                                                            <div 
                                                                              className="bg-blue-500 rounded-t-sm hover:bg-blue-600 relative z-10"
                                                                              style={{ 
                                                                                height: `${barHeight - globalLineHeight}px`,
                                                                                minHeight: '0px',
                                                                                width: '20px',
                                                                                position: 'absolute',
                                                                                bottom: `${globalLineHeight}px`
                                                                              }}
                                                                            />
                                                                            {/* Black portion below global average */}
                                                                            <div 
                                                                              className="bg-black hover:bg-[#1d203b] relative z-10"
                                                                              style={{ 
                                                                                height: `${globalLineHeight}px`,
                                                                                minHeight: '30px',
                                                                                width: '20px'
                                                                              }}
                                                                            />
                                                                          </>
                                                                        ) : (
                                                                          <div 
                                                                            className="bg-black rounded-t-sm hover:bg-[#1d203b] relative z-10"
                                                                            style={{ 
                                                                              height: `${barHeight}px`,
                                                                              minHeight: '30px',
                                                                              width: '20px'
                                                                            }}
                                                                          />
                                                                        )}
                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               {/* Value label */}
                            <div className="absolute left-1/2 transform -translate-x-1/2 text-base text-gray-700 z-20"
                                 style={{ 
                                   bottom: `${barHeight + 80}px`,
                                   textAlign: 'center',
                                   lineHeight: item.country === "Marshall Islands" || item.country === "Cook Islands" 
                                     ? '1.1' 
                                     : 'normal',
                                   color: '#9ca3af',
                                   fontSize: '0.875rem'
                                 }}>
                             {item.country}
                           </div>
                           <div className="absolute left-1/2 transform -translate-x-1/2 text-base text-gray-700 z-20"
                                style={{ 
                                  bottom: `${barHeight + 50}px`,
                                  textAlign: 'center',
                                  color: '#000000',
                                  fontSize: '1rem'
                                }}>
                             {item.selectedValue.toFixed(2)}M
                           </div>
                 </div>
               </div>
                           );
                         })}
        </div>
        
        {/* Country labels below the chart - REMOVED since names are now above bars */}
             </div>
      </div>
    </div>
  );
};

export default SeaLevelRiseChart; 